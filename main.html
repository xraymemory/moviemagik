<html>

<head>
    <link rel="stylesheet" href="node_modules/datatables.net-dt/css/jquery.dataTables.css">

    <title>Bayley's Magic Movie Time</title>
    <script>
        const electron = require("electron");
        const { spawn } = require('child_process');     

        var dt = require( 'datatables.net-dt' )();
        window.jQuery = window.$ = require('jquery');


        const ipc = electron.ipcRenderer;

        var resultjson = null;
        var table = null;

        var column_map = {
            1: "title",
            2: "year",
            3: "runtime",
            4: "language",
            5: "director",
            6: "dp",
            7: "color",
            8: "subdelay",
            9: "nickcage",
            10: "custom"
        };

        document.addEventListener("DOMContentLoaded", function(){

            ipc.send("mainWindowLoaded")

            ipc.on("resultSent", function(evt, result){
                let resultEl = document.getElementById("movieList");
                resultjson = {"data": result};
                console.log(resultjson);

                table = $('#movieData').DataTable({
                    "bAutoWidth": false,
                    "aaData": resultjson.data,
                    "createdRow": function( row, data, index ) {
                        console.log(row);
                        console.log(data["location"]);
                        row.cells[0].innerHTML = "<button type='button' onClick='playMovie(this)' id='play-button' class='" + data["location"] + "'>Play</button>";
                        for (var i = row.cells.length - 1; i > 0; i--) {
                            row.cells[i].setAttribute("contenteditable", true);
                            row.cells[i].setAttribute("db_col", column_map[i] );
                            row.cells[i].setAttribute("db_id", data["entry_id"]);
                        }
                    },
                    "columns": [
                    {
                        "data": "location"
                    },{
                        "data": "title"
                    }, {
                        "data": "year"
                    }, {
                        "data": "runtime"
                    }, {
                        "data": "language"
                    }, {
                        "data": "director"
                    },
                    {
                        "data": "dp"
                    },
                    {
                        "data": "color"
                    },
                    {
                        "data": "subdelay"
                    },
                    {
                        "data": "nickcage"
                    },
                    {
                        "data": "custom"
                    }
                    ]


                })
            });
        });

        window.onload = function() {
            document.getElementById('dirs').addEventListener('click', () => {
              ipc.send("select-dirs");

          })
        $('#movieData').on('keypress', 'tbody td', function (event) {
                if (event.key === "Enter"){
                    //let tab = $('#movieData').DataTable();
                    event.preventDefault();
                    console.log(event);
                    let update_value = event.target.innerText;
                    let update_column = event.target.getAttribute("db_col");
                    let update_id = event.target.getAttribute("db_id");
                    ipc.send("update-cell", update_value, update_column, update_id);
                }
            })

        };


    </script>

</head>
<body>  
    ✨Movie Magic✨
    <br>
    <br>
    <button type="button" id="dirs">Add directory</button>
    <br>
    <br>
    <table border='0' id="movieData" class="display">
        <thead>
            <tr>
                <th></th>
                <th>Title</th>
                <th>Year</th>
                <th>Runtime</th>
                <th>Language</th>
                <th>Director</th>
                <th>DP</th>
                <th>Color / BW </th>
                <th>Sub Delay</th>
                <th>Nick Cage?</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        function playMovie(playbtn){
            movie = playbtn.getAttribute("class");
            console.log(movie)
            ipc.send("play-movie", movie)

        }</script>
    </body>

    </html>